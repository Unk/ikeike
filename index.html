<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>이러케저러케</title>

    <!-- Bootstrap -->
 	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

	<style type="text/css">

		.media-list{ padding-top: 20px; }
		.result{ display: none; }
		.jumbotron{ padding: 10px 15px; }
		.loading{ text-align: center; margin-top: 40%; display: none; }

	</style>


  </head>
  <body>

	<div class="jumbotron">
	  <h1>이케이케!!</h1>
	</div>

	<div class="col-lg-6">
	    <div class="input-group">
	      <input type="text" class="form-control product-number">
	      <span class="input-group-btn">
	        <button id="comparebutton" class="btn btn-default" type="button">비교!!</button>
	      </span>
	    </div><!-- /input-group -->
		
		<div class="loading">
			<span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
		</div>

		<div class='result'>	
		<ul class="media-list">
		  <li class="media">
		    <a class="media-left" href="#">
		      <img src="" alt="...">
		    </a>
		    <div class="media-body">
		      <h4 class="media-heading">Product Name</h4>
		      <span></span>
		    </div>
		  </li>
		</ul>
		
		<span class="kr">
		<h5>한국 <span></span></h5>
		<div class="progress">
		  <div class="progress-bar progress-bar-info price-kr" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
		    20% Complete
		  </div>
		</div>
		</span>
		
		<span class="cn">
		<h5>중국 <span></span></h5>
		<div class="progress">
		  <div class="progress-bar progress-bar-warning price-cn" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
		    60% Complete (warning)
		  </div>
		</div>
		</span>
		
		<span class="jp">
		<h5>일본 <span></span></h5>
		<div class="progress">
		  <div class="progress-bar progress-bar-danger price-jp" role="progressbar" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
		   	80% Complete (danger)
		  </div>
		</div>
		</span>
		</div>
	</div><!-- /.col-lg-6 -->	



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="/jquery.ajax-cross-origin.min.js"></script>



	<script type="text/javascript">

	$(document).ready( function(){
		

		$('#comparebutton').click( function(){
			var no = $('.product-number').val().replace( /[.]/g, '');

			getProductInfo( no||'90160720' );
		});


		var cnt = 0;
		var result = { 'kr':'', 'jp':'', 'cn':'' };
		var converter = { 'jp':9.3, 'cn':177.4 };


		function getCurrency(){
			var ccnt = 0;

			$.ajax({
		      crossOrigin: true,
		      url: "http://www.webservicex.net/CurrencyConvertor.asmx/ConversionRate?FromCurrency=CNY&ToCurrency=KRW",
		      success: function( xml ) {
		      		converter['cn'] = Number($(xml).text());
		      }
		  	});

		  	$.ajax({
		      crossOrigin: true,
		      url: "http://www.webservicex.net/CurrencyConvertor.asmx/ConversionRate?FromCurrency=JPY&ToCurrency=KRW",
		      success: function( xml ) {
		      		converter['jp'] = Number($(xml).text());
		      }
		  	});

		};

		getCurrency();



		function getProductInfo( pNo ){
			console.log( 'getProductInfo:', pNo );
			initdisplay();
			$('.loading').css( 'display', 'block' );

			$.ajax({
		      crossOrigin: true,
		      url: "http://www.ikea.com/kr/ko/catalog/products/" + pNo,
		      success: function( html ) {
		      	var html = $(html);
		      	var price = html.find('#price1').text();

		      	$('.media-heading').text( html.find('#name.productName').text() );
		      	$('.media-body>span').text( price + '원' );
		      	$('a.media-left img').attr( 'src', "http://www.ikea.com/" + html.find( '#productInfoContainer img').attr('src'));

		      	$('.price-kr').text( price + ' 원' );
		      	$('.kr h5 span').text( price );

		      	$('.result').css( 'display', 'block' );
		      	$('.loading').css( 'display', 'none' );


		      	result['kr'] = price;
		      	cnt++;
		      	loadOtherCountry( pNo );
		      },

		      error: function(){
		      	alert('상품을 찾을 수 없습니다.');
		      }

		    });
		}

		function loadOtherCountry( pNo ){

			$.ajax({
		      crossOrigin: true,
		      url: "http://www.ikea.com/jp/en/catalog/products/" + pNo,
		      success: function( html ) {
		      	var price = $(html).find('#price1').text();
		      	$('.jp h5 span').text( price );

		      	result['jp'] = price;
		      	if( ++cnt == 3 ) displayAll();
		      },

		      error: function(){
		      	alert('일본 상품을 찾을 수 없습니다.');
		      }

		    });

		    $.ajax({
		      crossOrigin: true,
		      url: "http://www.ikea.com/cn/en/catalog/products/" + pNo,
		      success: function( html ) {
		      	var price = $(html).find('#price1').text();
		      	$('.cn h5 span').text( price );

		      	result['cn'] = price;
		      	if( ++cnt == 3 ) displayAll();
		      },

		      error: function(){
		      	alert('중국 상품을 찾을 수 없습니다.');
		      }

		    });


		}

		function initdisplay(){
			cnt = 0;


			$('.kr .progress-bar').css( 'width', '0%' );
			$('.jp .progress-bar').css( 'width', '0%' );
			$('.cn .progress-bar').css( 'width', '0%' );

			$('.price-kr').text( '' );
			$('.price-jp').text( '' );
			$('.price-cn').text( '' );

			$('.result').css( 'display', 'none' );

			$('.loading').css( 'display', 'none' );
		}

		function loading(){
			$('.loading').css( 'display', 'block' );
		}


		function displayAll(){
			var jp2kr = Number(result.jp.replace(',', '').match(/\d+/)) * converter.jp;
			var cn2kr = Number(result.cn.replace(',', '').match(/\d+/)) * converter.cn;
			var krprice= Number(result.kr.replace(',', '').match(/\d+/));
			var max = Math.max( jp2kr, cn2kr, krprice );

			displayPg( 'kr', krprice, max );
			displayPg( 'cn', cn2kr, max );
			displayPg( 'jp', jp2kr, max );

		}



		function displayPg( country, price, max ){
			if( price > 0 ){
				$( '.' + country + ' .progress-bar').css( 'width', (price/max)*100 + '%' );
				$('.price-' + country ).text( '₩ ' + commify( Math.round(price) + ' 원' ) );
			}else{
				$( '.' + country + ' .progress-bar').css( 'width', '100%' );
				$('.price-' + country ).text( '제품이 없던지 품번이 다른가봉가?' );
			}
		}


		function commify(n) {
		  var reg = /(^[+-]?\d+)(\d{3})/;   // 정규식
		  n += '';                          // 숫자를 문자열로 변환

		  while (reg.test(n))
		    n = n.replace(reg, '$1' + ',' + '$2');

		  return n;
		}

		function submitenter(myfield,e)
	    {
	        var keycode;
	        if (window.event) keycode = window.event.keyCode;
	        else if (e) keycode = e.which;
	        else return true;

	        if (keycode == 13)
	        {
	            myfield.form.submit();
	            return false;
	        }
	        else
	            return true;
	    }


	});

	</script>



  </body>
</html>